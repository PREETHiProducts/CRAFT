<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PREETHi PRODUCTS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    /* CORE STYLES */
    *{ margin:0; padding:0; box-sizing:border-box; }
    html,body{ width:100%; height:100%; scroll-behavior: smooth; }
    body{ font-family:'Poppins',sans-serif; background:linear-gradient(135deg,#fff5f8 0%,#ffd6eb 50%,#e0c3fc 100%); overflow-x:hidden; }
    #bgCanvas{ position:fixed; inset:0; width:100%; height:100%; z-index:0; pointer-events:none; }
    #toast-container {
        position: fixed; top: 100px; left: 50%; transform: translateX(-50%);
        z-index: 20000; display: flex; flex-direction: column; gap: 10px;
        pointer-events: none;
    }
    .toast {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.8);
        padding: 15px 25px; border-radius: 50px;
        box-shadow: 0 10px 30px rgba(106, 0, 75, 0.15);
        display: flex; align-items: center; gap: 12px;
        color: #4a0035; font-weight: 500; font-size: 14px;
        opacity: 0; transform: translateY(-20px) scale(0.9);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        pointer-events: auto; min-width: 300px; justify-content: center;
    }
    .toast.show { opacity: 1; transform: translateY(0) scale(1); }
    .toast.success i { color: #00b894; }
    .toast.error i { color: #ff6b6b; }
    .toast.info i { color: #8e44ad; }
    .auth-btn-container { 
        position: fixed; top: 20px; right: 30px; z-index: 9999; 
    }
    #signInBtn { 
        background: rgba(255, 255, 255, 0.75); 
        backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.8);
        box-shadow: 0 8px 20px rgba(0,0,0,0.05);
        padding: 10px 24px; border-radius: 50px; 
        color: #8e44ad; font-weight: 600; cursor: pointer; 
        transition: 0.3s; display: flex; align-items: center; gap: 10px; 
    }
    #signInBtn img { width: 32px; height: 32px; border-radius: 50%; border: 1px solid #8e44ad; object-fit: cover;}
    #signInBtn:hover { background: #fff; transform: translateY(-2px); box-shadow: 0 12px 25px rgba(142, 68, 173, 0.2); }
    .mobile-user-icon { display: none; }

    nav { 
        position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
        z-index: 9998; width: auto; 
        padding: 12px 40px; 
        background: rgba(255, 255, 255, 0.75); 
        backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
        border-radius: 50px; 
        display: flex; justify-content: center; align-items: center; 
        border: 1px solid rgba(255, 255, 255, 0.8); 
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    }
    nav ul { display: flex; gap: 40px; list-style: none; padding: 0; margin: 0; }
    nav li { 
        font-size: 14px; color: #5a3055; font-weight: 600; 
        cursor: pointer; position: relative; letter-spacing: 0.5px;
        transition: 0.3s;
    }
    nav li:hover { color: #8e44ad; }
    nav li i { display: none; }
    
    .cart-wrapper { position: relative; }
    .cart-badge {
        position: absolute; top: -8px; right: -12px;
        background: #ff6b6b; color: white;
        font-size: 10px; font-weight: bold;
        width: 18px; height: 18px;
        display: flex; align-items: center; justify-content: center;
        border-radius: 50%;
        box-shadow: 0 2px 5px rgba(255, 107, 107, 0.4);
        opacity: 0; transform: scale(0); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .cart-badge.active { opacity: 1; transform: scale(1); }

    .hero{ position:relative; z-index:5; min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding-inline:16px; padding-top: 80px; }
    svg{ width:100%; max-width:1000px; height:auto; }
    text{ font-family:'Playfair Display',serif; font-size:clamp(46px,9vw,92px); letter-spacing:6px; fill:#6a004b; filter:drop-shadow(0 6px 14px rgba(106,0,75,.25)); }
    .bouquet{ width:clamp(260px,70vw,420px); max-width:92%; margin-top:-6vh; filter:drop-shadow(0 22px 32px rgba(0,0,0,.18)); animation:float 6s ease-in-out infinite; }
    @keyframes float{ 0%,100%{transform:translateY(0)} 50%{transform:translateY(-24px)} }
    .tagline{ margin-top:14px; font-size:clamp(11px,2.4vw,14px); letter-spacing:2.5px; text-transform:uppercase; color:#8e44ad; }

    #collection { 
        position: relative; z-index: 10; padding: 50px 5% 150px 5%; 
        display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); 
        gap: 50px; max-width: 1400px; margin: 0 auto; 
    }

    .product-card {
        position: relative;
        background: rgba(255, 255, 255, 0.4); 
        backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        border-radius: 35px;
        padding: 15px;
        border: 1px solid rgba(255, 255, 255, 0.7); 
        box-shadow: 0 15px 40px rgba(106, 0, 75, 0.05); 
        transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
        display: flex; flex-direction: column;
    }
    .product-card:hover { transform: translateY(-10px); background: rgba(255, 255, 255, 0.65); box-shadow: 0 25px 55px rgba(106, 0, 75, 0.12); border-color: #fff; }
    .img-wrapper { position: relative; width: 100%; padding-top: 110%; border-radius: 25px; overflow: hidden; margin-top: -10px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); z-index: 2; }
    .product-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: transform 1.2s ease; }
    .product-card:hover .product-img { transform: scale(1.08); }
    .card-content { padding: 25px 15px 10px 15px; text-align: center; }
    .product-name { font-family: 'Playfair Display', serif; font-size: 1.5rem; color: #4a0035; font-weight: 700; margin-bottom: 12px; line-height: 1.2; letter-spacing: 0.5px; }
    .price-container { display: inline-flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.55); border: 1px solid rgba(255, 255, 255, 0.8); padding: 8px 20px; border-radius: 50px; margin-bottom: 22px; gap: 10px; }
    .price-tag { font-size: 1.3rem; color: #6a004b; font-weight: 700; font-family: 'Poppins', sans-serif; }
    .discount { font-size: 0.85rem; text-decoration: line-through; color: #a0a0a0; font-weight: 500; }
    .card-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .btn { padding: 14px; border-radius: 18px; border: none; cursor: pointer; font-family: 'Poppins', sans-serif; font-weight: 600; font-size: 0.8rem; letter-spacing: 0.5px; text-transform: uppercase; transition: all 0.3s ease; }
    .btn-buy { background: #6a004b; color: #fff; box-shadow: 0 8px 15px rgba(106, 0, 75, 0.2); }
    .btn-cart { background: rgba(255, 255, 255, 0.8); color: #6a004b; border: 1px solid rgba(255,255,255,0.5); }
    .btn:hover { transform: translateY(-2px); filter: brightness(1.05); }
    .dots-container { position: absolute; top: 25px; right: 25px; z-index: 5; background: rgba(255,255,255,0.6); padding: 6px 10px; border-radius: 20px; display: flex; gap: 5px; backdrop-filter: blur(5px); }
    .dot { width: 5px; height: 5px; background: rgba(106,0,75,0.2); border-radius: 50%; transition: 0.3s; }
    .dot.active { width: 15px; background: #6a004b; border-radius: 5px; }

    #cartSidebar {
        position: fixed; right: -420px; top: 0; width: 400px; height: 100%;
        background: rgba(255, 255, 255, 0.7); 
        backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
        z-index: 10000; transition: 0.6s cubic-bezier(0.19, 1, 0.22, 1);
        padding: 30px; border-left: 1px solid rgba(255,255,255,0.5);
        display: flex; flex-direction: column;
        box-shadow: -20px 0 50px rgba(0,0,0,0.05);
    }
    #cartSidebar.active { right: 0; }
    .cart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .cart-header h2 { font-family: 'Playfair Display', serif; color: #4a0035; font-size: 24px; }
    .close-cart-btn { background: none; border: none; font-size: 20px; color: #8e44ad; cursor: pointer; transition: 0.3s; }
    .close-cart-btn:hover { transform: rotate(90deg); color: #ff6b6b; }
    #cartItems { flex: 1; overflow-y: auto; padding-right: 5px; display: flex; flex-direction: column; gap: 15px; }
    .cart-item { display: flex; align-items: center; background: rgba(255,255,255,0.5); border-radius: 16px; padding: 10px; border: 1px solid rgba(255,255,255,0.6); transition: 0.3s; }
    .cart-item:hover { background: rgba(255,255,255,0.8); }
    .cart-item-img { width: 60px; height: 60px; border-radius: 12px; object-fit: cover; margin-right: 15px; }
    .cart-item-details { flex: 1; }
    .cart-item-name { font-weight: 600; color: #4a0035; font-size: 13px; margin-bottom: 4px; }
    .cart-item-price { color: #8e44ad; font-size: 12px; font-weight: 500; }
    .qty-wrap { display: flex; align-items: center; gap: 5px; margin-top: 5px; }
    .qty-btn { width: 22px; height: 22px; background: #6a004b; color: white; border: none; border-radius: 6px; cursor: pointer; }
    .qty-input { width: 35px; height: 22px; text-align: center; border: 1px solid rgba(0,0,0,0.1); background: transparent; border-radius: 4px; font-size: 12px; }
    .cart-item-remove { background: #ffebeb; color: #ff6b6b; width: 28px; height: 28px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; margin-left: 10px; }
    .cart-item-remove:hover { background: #ff6b6b; color: white; }
    .cart-footer { margin-top: 25px; border-top: 1px solid rgba(106,0,75,0.05); padding-top: 20px; }
    .cart-total-row { display: flex; justify-content: space-between; font-size: 18px; color: #4a0035; font-weight: 700; margin-bottom: 20px; }
    .checkout-btn { width: 100%; padding: 16px; background: #6a004b; color: white; border: none; border-radius: 16px; font-weight: 600; letter-spacing: 1px; cursor: pointer; box-shadow: 0 10px 25px rgba(106, 0, 75, 0.2); transition: 0.3s; }
    .checkout-btn:hover { transform: translateY(-2px); box-shadow: 0 15px 35px rgba(106, 0, 75, 0.3); }

    #checkoutModal, #myOrdersModal {
        position: fixed; inset: 0; z-index: 11000;
        background: rgba(60, 20, 40, 0.2); backdrop-filter: blur(8px);
        display: none; justify-content: center; align-items: center;
        opacity: 0; transition: opacity 0.3s;
    }
    #checkoutModal.open, #myOrdersModal.open { display: flex; opacity: 1; }
    .modal-content {
        background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px);
        padding: 40px; border-radius: 35px; width: 90%; max-width: 420px;
        text-align: center; box-shadow: 0 25px 60px rgba(0,0,0,0.1);
        border: 1px solid rgba(255,255,255,0.8);
        transform: translateY(30px); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    #checkoutModal.open .modal-content, #myOrdersModal.open .modal-content { transform: translateY(0); }
    .modal-title { font-family: 'Playfair Display'; color: #6a004b; margin-bottom: 25px; font-size: 26px; }
    .form-group { margin-bottom: 18px; text-align: left; }
    .form-group label { display: block; font-size: 11px; font-weight: 700; color: #8e44ad; margin-bottom: 6px; letter-spacing: 1px; text-transform: uppercase; }
    .form-input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.05); background: rgba(255,255,255,0.6); outline: none; font-family: inherit; transition: 0.3s; }
    .form-input:focus { background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-color: #e0c3fc; }
    .btn-send { background: #00b894; color: white; width: 100%; padding: 16px; border: none; border-radius: 16px; font-weight: 600; font-size: 15px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; transition: 0.3s; }
    .btn-send:hover { background: #00a383; transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0, 184, 148, 0.25); }
    .btn-close-modal { position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 24px; color: #aaa; cursor: pointer; }
    .btn-close-modal:hover { color: #ff6b6b; }

    #myOrdersList { max-height: 300px; overflow-y: auto; text-align: left; display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .my-order-item { background: white; padding: 15px; border-radius: 15px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .mo-info { font-size: 12px; color: #555; }
    .mo-info strong { display: block; color: #6a004b; font-size: 14px; margin-bottom: 2px; }
    .btn-cancel-order { background: #ff6b6b; color: white; border: none; padding: 8px 12px; border-radius: 10px; font-size: 11px; cursor: pointer; font-weight: 600; }
    .btn-cancel-order:disabled { background: #eee; color: #aaa; cursor: not-allowed; }

    @media (max-width:768px){ 
        .auth-btn-container { top: 15px; right: 15px; }
        #signInBtn { padding: 0; border-radius: 50%; width: 50px; height: 50px; justify-content: center; backdrop-filter: blur(10px); background: rgba(255,255,255,0.85); }
        #btnText { display: none; }
        .mobile-user-icon { display: block; font-size: 40px; color: #8e44ad; }
        #signInBtn img { margin: 0; width: 44px; height: 44px; }
        nav { 
            position: fixed; top: auto; bottom: 20px; left: 50%; transform: translateX(-50%); 
            width: 90%; max-width: 400px; padding: 15px 0; border-radius: 35px;
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        nav ul { width: 100%; justify-content: space-evenly; gap: 0; }
        nav li span { display: none; }
        nav li i { display: block; font-size: 20px; color: #8e44ad; }
        nav li.active i { color: #6a004b; transform: scale(1.1); }
        .cart-wrapper { position: relative; display: inline-block; }
        .cart-badge { top: -5px; right: -8px; width: 16px; height: 16px; font-size: 9px; border: 2px solid #fff; }
        #collection { gap: 30px; padding: 20px 5% 120px 5%; }
        #cartSidebar { width: 100%; right: -100%; }
        #cartSidebar.active { right: 0; }
        .hero { padding-top: 10px; }
        text{ font-size:clamp(50px, 12vw, 80px); }
    }
    @media screen and (min-width: 768px) and (max-width: 1200px) {
        nav ul { width: 100%; justify-content: space-evenly; gap: 65px; }
        nav li span { display: none; }
        nav li i { display: block; font-size: 20px; color: #8e44ad; }
        text{ font-size:clamp(55px,4vw,104px); }
        .bouquet{ width:clamp(450px,32vw,620px); margin-top:-20vh; }
    }
    @media (min-width:768px){ text{ font-size:clamp(55px,4vw,104px); } .bouquet{ width:clamp(450px,32vw,620px); margin-top:-20vh; } }
</style>
</head>

<body>

<canvas id="bgCanvas"></canvas>

<div id="toast-container"></div>

<div class="auth-btn-container">
    <button id="signInBtn">
        <i class="fas fa-user-circle mobile-user-icon"></i>
        <span id="btnText">Sign In</span>
    </button>
</div>

<nav>
    <ul>
        <li onclick="window.scrollTo(0,0)"><i class="fas fa-home"></i><span> Home</span></li>
        <li onclick="document.getElementById('collection').scrollIntoView()"><i class="fas fa-th-large"></i><span> Collection</span></li>
        <li onclick="toggleCart()" class="cart-wrapper">
            <i class="fas fa-shopping-bag"></i>
            <span>Cart</span>
            <div id="cartBadge" class="cart-badge">0</div>
        </li>
        <li onclick="openMyOrders()"><i class="fas fa-clipboard-list"></i><span> My Orders</span></li>
        <li onclick="window.open('https://wa.me/94774108627', '_blank')"><i class="fab fa-whatsapp"></i><span> Chat</span></li>
    </ul>
</nav>

<section class="hero">
    <svg viewBox="0 0 1000 220" preserveAspectRatio="xMidYMid meet">
        <defs><path id="curve" d="M80,160 Q500,10 920,160"/></defs>
        <text><textPath href="#curve" startOffset="50%" text-anchor="middle">PREETHi PRODUCTS</textPath></text>
    </svg>
    <img src="bouquet.webp" class="bouquet" alt="Flower Bouquet">
    <div class="tagline">Crafted with Care • Delivered with Joy</div>
</section>

<div id="collection"></div>

<div id="cartSidebar">
    <div class="cart-header">
        <h2>Your Selection</h2>
        <button class="close-cart-btn" onclick="toggleCart()"><i class="fas fa-times"></i></button>
    </div>
    
    <div id="cartItems"></div>

    <div class="cart-footer">
        <div class="cart-total-row">
            <span>Total</span>
            <span>Rs.<span id="cartTotal">0</span></span>
        </div>
        <button class="checkout-btn" onclick="checkout()">
            <span>BUY NOW</span>
        </button>
    </div>
</div>

<div id="checkoutModal">
    <div class="modal-content">
        <button class="btn-close-modal" onclick="closeCheckout()">&times;</button>
        <h2 class="modal-title">Complete Order</h2>
        <div class="form-group">
            <label>YOUR NAME</label>
            <input type="text" id="custName" class="form-input" placeholder="e.g. John Doe">
        </div>
        <div class="form-group">
            <label>MOBILE NUMBER</label>
            <input type="tel" id="custPhone" class="form-input" placeholder="e.g. 077 123 4567">
        </div>
        <div class="form-group">
            <label>DELIVERY ADDRESS</label>
            <input type="text" id="custAddress" class="form-input" placeholder="e.g. 123 Flower St, Colombo">
        </div>
        <button class="btn-send" onclick="confirmOrder()">
            <span>Send via WhatsApp</span>
            <i class="fab fa-whatsapp"></i>
        </button>
    </div>
</div>

<div id="myOrdersModal">
    <div class="modal-content">
        <button class="btn-close-modal" onclick="document.getElementById('myOrdersModal').classList.remove('open')">&times;</button>
        <h2 class="modal-title">My Recent Orders</h2>
        <div id="myOrdersList"></div>
        <p style="font-size:11px; color:#888;">Orders can be canceled within 10 minutes of placement.</p>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, orderBy, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD8nbG5Pfjo1cAGf5dG6vgTsyDl5MAFpv0",
        authDomain: "craft-72780.firebaseapp.com",
        projectId: "craft-72780",
        storageBucket: "craft-72780.firebasestorage.app",
        messagingSenderId: "911657969290",
        appId: "1:911657969290:web:0890417efcc2eeaa34ef73",
        measurementId: "G-B5WRW9556N"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });

    let currentUser = null;
    let cart = JSON.parse(localStorage.getItem('guestCart')) || [];
    const WA_NUMBER = "94774108627"; 

    // Toast
    window.showToast = (message, type = 'info') => {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        let icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';
        toast.innerHTML = `<i class="fas fa-${icon}"></i> <span>${message}</span>`;
        container.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add('show'));
        setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 400); }, 3000);
    };

    // Close Modals logic
    document.addEventListener('click', (e) => {
        const sidebar = document.getElementById('cartSidebar');
        const coModal = document.getElementById('checkoutModal');
        const moModal = document.getElementById('myOrdersModal');
        
        if (sidebar.classList.contains('active') && !sidebar.contains(e.target) && !e.target.closest('.cart-wrapper') && !e.target.closest('.btn-cart') && !e.target.closest('.qty-btn') && !e.target.closest('.btn-buy')) {
            sidebar.classList.remove('active');
        }
        if(e.target === coModal) closeCheckout();
        if(e.target === moModal) moModal.classList.remove('open');
    });

    // Render Collection
    const collectionDiv = document.getElementById('collection');
    const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
    onSnapshot(q, (snapshot) => {
        collectionDiv.innerHTML = ''; 
        snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const productId = docSnap.id;
            const images = data.images && data.images.length > 0 ? data.images : ['https://via.placeholder.com/500'];
            const card = `
                <div class="product-card">
                    <div class="dots-container" id="dots-${productId}">
                        <div class="dot active"></div><div class="dot"></div><div class="dot"></div>
                    </div>
                    <div class="img-wrapper" onclick="nextImage('${productId}')">
                        <img src="${images[0]}" class="product-img" id="img-${productId}" data-index="0" data-urls='${JSON.stringify(images)}'>
                    </div>
                    <div class="card-content">
                        <h3 class="product-name">${data.name}</h3>
                        <div class="price-container">
                            <span class="price-tag">Rs.${data.price}</span>
                            ${data.discount ? `<span class="discount">Rs.${data.discount}</span>` : ''}
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-cart" onclick="addToCart('${data.name}', ${data.price}, '${images[0]}')">Add to Cart</button>
                            <button class="btn btn-buy" onclick="buyDirect('${data.name}', ${data.price}, '${images[0]}')">Buy Now</button>
                        </div>
                    </div>
                </div>`;
            collectionDiv.insertAdjacentHTML('beforeend', card);
        });
    });

    window.nextImage = (id) => {
        const imgElement = document.getElementById(`img-${id}`);
        const urls = JSON.parse(imgElement.dataset.urls);
        let currentIndex = (parseInt(imgElement.dataset.index) + 1) % urls.length;
        imgElement.src = urls[currentIndex];
        imgElement.dataset.index = currentIndex;
        document.getElementById(`dots-${id}`).querySelectorAll('.dot').forEach((dot, i) => dot.classList.toggle('active', i === (currentIndex % urls.length)));
    };

    // Auth
    const authBtn = document.getElementById('signInBtn');
    authBtn.addEventListener('click', async () => {
        if (!currentUser) try { await signInWithPopup(auth, provider); } catch (e) { console.error(e); }
        else if(confirm("Sign out?")) signOut(auth);
    });

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            if (window.innerWidth > 768) {
                authBtn.innerHTML = `
                    <img src="${user.photoURL}" style="width:32px; height:32px; border-radius:50%; border:1px solid #8e44ad; object-fit:cover;"> 
                    <span>${user.displayName.split(' ')[0]}</span>`;
            } else {
                authBtn.innerHTML = `
                    <img src="${user.photoURL}" style="width:44px; height:44px; border-radius:50%; border:1px solid #8e44ad; object-fit:cover;">`;
            }
            
            const docRef = doc(db, "carts", user.email);
            const docSnap = await getDoc(docRef);
            let remoteItems = docSnap.exists() ? docSnap.data().items || [] : [];
            if (cart.length > 0) {
                cart = [...remoteItems, ...cart]; 
                await setDoc(docRef, { items: cart }); 
                localStorage.removeItem('guestCart');
            } else cart = remoteItems;
            updateCartUI();
            showToast(`Welcome back!`, 'success');
        } else {
            // ... rest of your existing sign out logic ...
            authBtn.innerHTML = `<i class="fas fa-user-circle mobile-user-icon"></i><span id="btnText">Sign In</span>`;
            currentUser = null; 
            cart = JSON.parse(localStorage.getItem('guestCart')) || []; 
            updateCartUI();
        }
    });

    // Cart Logic
    window.addToCart = async (name, price, image, showSidebar = true) => {
        const existing = cart.find(i => i.name === name);
        if(existing) { if(existing.quantity < 100) existing.quantity++; } 
        else cart.push({ name, price, image, id: Date.now(), quantity: 1 });
        updateCartUI(); saveCartData();
        if(showSidebar) { document.getElementById('cartSidebar').classList.add('active'); showToast(`${name} added`, 'success'); }
    };

    window.buyDirect = async (name, price, image) => {
        cart = [{ name, price, image, id: Date.now(), quantity: 1 }];
        updateCartUI(); saveCartData();
        document.getElementById('checkoutModal').classList.add('open'); 
    };

    window.updateQty = (id, newQty) => { const item = cart.find(i => i.id === id); if(item) { item.quantity = Math.max(1, Math.min(100, parseInt(newQty) || 1)); updateCartUI(); saveCartData(); } };
    window.changeQty = (id, delta) => { const item = cart.find(i => i.id === id); if(item) { item.quantity = Math.max(1, Math.min(100, item.quantity + delta)); updateCartUI(); saveCartData(); } };
    window.removeFromCart = (id) => { cart = cart.filter(item => item.id !== id); updateCartUI(); saveCartData(); };
    async function saveCartData() { if (currentUser) await setDoc(doc(db, "carts", currentUser.email), { items: cart }); else localStorage.setItem('guestCart', JSON.stringify(cart)); }

    window.updateCartUI = () => {
        const container = document.getElementById('cartItems');
        const badge = document.getElementById('cartBadge');
        let total = 0; container.innerHTML = '';
        if(cart.length === 0) { container.innerHTML = '<div style="text-align:center; color:#8e44ad; padding-top:50px; opacity:0.7;">Your cart is empty</div>'; badge.classList.remove('active'); badge.innerText = '0'; }
        else { badge.classList.add('active'); badge.innerText = cart.length; }
        cart.forEach((item) => {
            total += (item.price * item.quantity);
            container.insertAdjacentHTML('beforeend', `
                <div class="cart-item"><img src="${item.image}" class="cart-item-img">
                    <div class="cart-item-details"><div class="cart-item-name">${item.name}</div><div class="cart-item-price">Rs.${item.price}</div>
                        <div class="qty-wrap"><button class="qty-btn" onclick="changeQty(${item.id}, -1)">-</button><input type="number" class="qty-input" value="${item.quantity}" min="1" max="100" onchange="updateQty(${item.id}, this.value)"><button class="qty-btn" onclick="changeQty(${item.id}, 1)">+</button></div>
                    </div><button class="cart-item-remove" onclick="removeFromCart(${item.id})"><i class="fas fa-trash-alt"></i></button></div>`);
        });
        document.getElementById('cartTotal').innerText = total;
    };

    window.toggleCart = () => document.getElementById('cartSidebar').classList.toggle('active');
    window.checkout = () => { if(cart.length === 0) return showToast("Cart is empty!", "error"); document.getElementById('cartSidebar').classList.remove('active'); document.getElementById('checkoutModal').classList.add('open'); };
    window.closeCheckout = () => document.getElementById('checkoutModal').classList.remove('open');

    // --- ORDER & CANCELLATION LOGIC ---
    
    // Store local orders in LocalStorage to track time
    function saveMyOrder(orderId, items, total) {
        let myOrders = JSON.parse(localStorage.getItem('myOrders')) || [];
        myOrders.unshift({
            id: orderId,
            items: items.map(i => `${i.name} (x${i.quantity})`).join(', '),
            total: total,
            timestamp: Date.now(),
            status: 'active'
        });
        // Keep last 10 orders
        if(myOrders.length > 10) myOrders.pop();
        localStorage.setItem('myOrders', JSON.stringify(myOrders));
    }

    window.openMyOrders = () => {
        const modal = document.getElementById('myOrdersModal');
        const container = document.getElementById('myOrdersList');
        const myOrders = JSON.parse(localStorage.getItem('myOrders')) || [];
        container.innerHTML = '';

        if(myOrders.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#aaa; padding:20px;">No recent orders found on this device.</div>';
        } else {
            const now = Date.now();
            myOrders.forEach(order => {
                if(order.status !== 'deleted') {
                    // Check 10 minute window (10 * 60 * 1000 = 600000)
                    const isCancellable = (now - order.timestamp) < 600000;
                    
                    const timeString = new Date(order.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    const btnHtml = isCancellable 
                        ? `<button class="btn-cancel-order" onclick="cancelMyOrder('${order.id}')">Cancel</button>`
                        : `<button class="btn-cancel-order" disabled>Too late to cancel</button>`;

                    container.insertAdjacentHTML('beforeend', `
                        <div class="my-order-item" id="ord-${order.id}">
                            <div class="mo-info">
                                <strong>Order #${order.id.substring(0,6).toUpperCase()}</strong>
                                ${order.items}<br>
                                Rs. ${order.total} • ${timeString}
                            </div>
                            ${btnHtml}
                        </div>
                    `);
                }
            });
        }
        modal.classList.add('open');
    }

    window.cancelMyOrder = async (orderId) => {
        if(!confirm("Are you sure you want to cancel this order?")) return;
        
        try {
            // 1. Delete from Firestore
            await deleteDoc(doc(db, "messages", orderId));
            
            // 2. Update Local Storage
            let myOrders = JSON.parse(localStorage.getItem('myOrders')) || [];
            const index = myOrders.findIndex(o => o.id === orderId);
            if(index !== -1) {
                myOrders.splice(index, 1); // Remove from list or mark as deleted
                localStorage.setItem('myOrders', JSON.stringify(myOrders));
            }

            // 3. UI Update
            const row = document.getElementById(`ord-${orderId}`);
            if(row) {
                row.style.opacity = '0.5';
                row.innerHTML = '<div style="padding:10px; color:#ff6b6b; text-align:center; width:100%;">Order Canceled Successfully</div>';
                setTimeout(() => row.remove(), 2000);
            }
            showToast("Order Canceled", "success");
        } catch (error) {
            console.error("Cancel Error", error);
            showToast("Could not cancel (Order might already be processed)", "error");
        }
    }

    window.confirmOrder = async () => {
        const name = document.getElementById('custName').value.trim();
        const phone = document.getElementById('custPhone').value.trim();
        const address = document.getElementById('custAddress').value.trim();

        if(!name || !address || !phone) {
            showToast("Please fill Name, Mobile & Address", "error");
            return;
        }

        if(cart.length === 0) return showToast("Cart is empty", "error");

        let total = 0;
        let itemsString = "";
        cart.forEach(item => { total += (item.price * item.quantity); itemsString += `- ${item.name} (x${item.quantity})\n`; });

        const orderData = {
            customerName: name,
            customerPhone: phone,
            customerAddress: address,
            items: cart,
            total: total,
            timestamp: Date.now()
        };

        try {
            const docRef = await addDoc(collection(db, "messages"), orderData);
            
            // Save locally for cancellation tracking
            saveMyOrder(docRef.id, cart, total);

            const waText = encodeURIComponent(
                `*New Order!* \n\n` +
                `*Name:* ${name}\n` +
                `*Mobile:* ${phone}\n` +
                `*Address:* ${address}\n\n` +
                `*Items:*\n${itemsString}\n` +
                `*Total: Rs.${total}*`
            );

            cart = []; updateCartUI(); saveCartData(); closeCheckout();
            document.getElementById('custName').value = '';
            document.getElementById('custPhone').value = '';
            document.getElementById('custAddress').value = '';
            
            showToast("Order Placed! Check 'My Orders' to track.", "success");
            setTimeout(() => window.open(`https://wa.me/${WA_NUMBER}?text=${waText}`, '_blank'), 1000);

        } catch (error) { console.error("Error:", error); showToast("Something went wrong.", "error"); }
    };
</script>

<script>
// Background Animation
const canvas = document.getElementById('bgCanvas'); const ctx = canvas.getContext('2d');
let particles=[]; function resize(){ canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
window.addEventListener('resize',resize); resize();
class Particle{ constructor(type){ this.type=type; this.reset(); } reset(){ this.x=Math.random()*canvas.width; this.y=Math.random()*canvas.height-canvas.height; this.size=this.type==='petal'?Math.random()*8+4:Math.random()*2+1; this.speed=Math.random()*1.5+.5; this.vx=Math.random()*1-.5; this.opacity=Math.random()*.6+.2; this.rot=Math.random()*360; this.rotSpd=Math.random()*2-1; } draw(){ ctx.save(); ctx.translate(this.x,this.y); ctx.rotate(this.rot*Math.PI/180); if(this.type==='petal'){ ctx.fillStyle=`rgba(255,182,193,${this.opacity})`; ctx.beginPath(); ctx.moveTo(0,0); ctx.quadraticCurveTo(this.size,-this.size,this.size*2,0); ctx.quadraticCurveTo(this.size,this.size,0,0); ctx.fill(); }else{ ctx.fillStyle=`rgba(255,255,255,${this.opacity})`; ctx.beginPath(); ctx.arc(0,0,this.size,0,Math.PI*2); ctx.fill(); } ctx.restore(); } update(){ this.y+=this.speed; this.x+=this.vx+Math.sin(this.y/50); this.rot+=this.rotSpd; if(this.y>canvas.height+30) this.reset(); } }
function init(){ for(let i=0;i<40;i++)particles.push(new Particle('petal')); for(let i=0;i<70;i++)particles.push(new Particle('shine')); }
function animate(){ ctx.clearRect(0,0,canvas.width,canvas.height); particles.forEach(p=>{ p.update(); p.draw(); }); requestAnimationFrame(animate); }
init(); animate();
</script>

</body>
</html>
